#!/bin/bash

if ! which git >/dev/null 2>&1; then
  echo 'Please install git'
  exit 1
fi

CYAN='\033[0;34m'
NC='\033[0m'

cd

mkdir -p ~/.cache/vim
mkdir -p ~/.mlterm
mkdir -p ~/.config/fish/functions
mkdir -p ~/.config/fontconfig
mkdir -p ~/.config/peco
mkdir -p ~/.config/byobu
mkdir -p ~/.config/nyaovim
mkdir -p ~/.config/termite
mkdir -p ~/.config/tym
mkdir -p ~/.local/share/fonts
mkdir -p ~/src
mkdir -p ~/wineprefixes

touch ~/.gitconfig_local

# git
ln -fs ~/dotfiles/gitconfig ~/.gitconfig
ln -fs ~/dotfiles/gitignore_global ~/.gitignore_global
ln -fs ~/dotfiles/gitscripts ~/.gitscripts

# zsh
ln -fs ~/dotfiles/zshrc ~/.zshrc

# bash
ln -fs ~/dotfiles/bashrc ~/.bashrc

# tmux
ln -fs ~/dotfiles/tmux.conf ~/.tmux.conf
ln -fs ~/dotfiles/byobu.conf ~/.config/byobu/.tmux.conf

# fish
ln -fs ~/dotfiles/config.fish ~/.config/fish/config.fish

# vim
ln -fs ~/dotfiles/vim/init.vim ~/.vimrc
ln -fs ~/dotfiles/vimrc ~/.vimrc
ln -fsn ~/dotfiles/vim ~/.vim

# neovim
ln -fsn ~/dotfiles/vim ~/.config/nvim

# X org
ln -fs ~/dotfiles/Xdefaults ~/.Xdefaults
ln -fs ~/dotfiles/Xresources ~/.Xresources

# tym
ln -fs ~/dotfiles/tym.lua ~/.config/tym/config.lua

# termite
ln -fs ~/dotfiles/termite/config ~/.config/termite/config

# fonts
ln -fs ~/dotfiles/fonts.conf ~/.config/fontconfig/fonts.conf
ln -fsn ~/dotfiles/fonts ~/.local/share/fonts/dotfiles

# editorconfig
ln -fs ~/dotfiles/editorconfig ~/.editorconfig

# editorconfig
ln -fs ~/dotfiles/tigrc ~/.tigrc

# peco
ln -fs ~/dotfiles/peco.json ~/.config/peco/config.json

# yaourt
ln -fs ~/dotfiles/yaourtrc ~/.yaourtrc

# mlterm
ln -fs ~/dotfiles/mlterm/main ~/.mlterm/main
ln -fs ~/dotfiles/mlterm/color ~/.mlterm/color
ln -fs ~/dotfiles/mlterm/font ~/.mlterm/font
ln -fs ~/dotfiles/mlterm/font ~/.mlterm/aafont
ln -fs ~/dotfiles/mlterm/key ~/.mlterm/key

# vimperator
ln -fs ~/dotfiles/vimperatorrc ~/.vimperatorrc

# vimfx
ln -fsn ~/dotfiles/vimfx ~/.config/vimfx

# ideavim
ln -fs ~/dotfiles/ideavimrc ~/.ideavimrc

# nyaovim
ln -fs ~/dotfiles/nyaovimrc.html ~/.config/nyaovim/nyaovimrc.html

# compton
ln -fs ~/dotfiles/compton.conf ~/.config/compton.conf
ln -fs ~/.config/compton.conf ~/.config/marco-compton.conf

# wine
ln -fs ~/.wine ~/wineprefixes/current


changed=false

nodejs=false
python=false
ruby=false
zplug=false
dein=false

for i in "$@" ; do
  case "$i" in
    'nodejs' | 'node' ) nodejs=true ;;
    'python' | 'py'   ) python=true ;;
    'ruby'   | 'rb'   ) ruby=true ;;
    'zplug'  | 'zp'   ) zplug=true ;;
    'dein'   | 'dn'   ) dein=true ;;
    'all' )
      nodejs=true
      python=true
      ruby=true
      zplug=true
      dein=true
      ;;
    'us' )
      ln -fs ~/dotfiles/Xmodmap_us ~/.Xmodmap
      ;;
    'jis' )
      ln -fs ~/dotfiles/Xmodmap_jis ~/.Xmodmap
      ;;
  esac
done

if [ `which setxkbmap` ] && [[ -e ~/.Xmodmap ]]; then
  setxkbmap && xmodmap ~/.Xmodmap
  echo -e "${CYAN}Loaded Xmodmap${NC}"
fi

if $nodejs; then
  changed=true
  if [ ! -d ~/.nodebrew ]; then
    echo
    echo -e "${CYAN}Installing nodebrew${NC}"
    curl -L git.io/nodebrew | perl - setup
    echo -e "${CYAN}Installing node.js v7${NC}"
    ~/.nodebrew/nodebrew install-binary 7
  else
    echo -e "${CYAN}Updating nodebrew${NC}"
    ~/.nodebrew/nodebrew selfupdate
  fi
fi


if $python; then
  changed=true
  if [ ! -d ~/.pyenv ]; then
    echo
    echo -e "${CYAN}Installing pyenv${NC}"
    git clone https://github.com/yyuu/pyenv.git ~/.pyenv
  else
    echo -e "${CYAN}Updating pyenv${NC}"
    cd ~/.pyenv
    git pull
    cd
    echo
  fi

  if [ ! -d ~/.pyenv/plugins/pyenv-virtualenv ]; then
    echo
    echo -e "${CYAN}Installing pyenv-virtualenv${NC}"
    git clone https://github.com/yyuu/pyenv-virtualenv.git ~/.pyenv/plugins/pyenv-virtualenv
  else
    echo -e "${CYAN}Updating pyenv-virtualenv${NC}"
    cd ~/.pyenv/plugins/pyenv-virtualenv
    git pull
    cd
    echo
  fi
fi


if $ruby; then
  changed=true
  if [ ! -d ~/.rbenv ]; then
    echo
    echo -e "${CYAN}Installing rbenv${NC}"
    git clone https://github.com/rbenv/rbenv.git ~/.rbenv
  else
    echo -e "${CYAN}Updating rbenv${NC}"
    cd ~/.rbenv
    git pull
    cd
    echo
  fi
  if [ ! -d ~/.rbenv/plugins/ruby-build ]; then
    echo
    echo -e "${CYAN}Installing ruby-build${NC}"
    git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
  else
    echo -e "${CYAN}Updating ruby-build${NC}"
    cd ~/.rbenv/plugins/ruby-build
    git pull
    cd
    echo
  fi
fi


if $zplug; then
  changed=true
  if [ ! -d ~/.zplug ]; then
    echo
    echo -e "${CYAN}Installing zplug${NC}"
    git clone https://github.com/zplug/zplug ~/.zplug
  else
    echo -e "${CYAN}Updating zplug${NC}"
    cd ~/.zplug
    git pull
    cd
    echo
  fi
fi


if $dein; then
  changed=true
  dein_base_dir=~/.cache/dein/repos/github.com/Shougo
  dein_dir=$dein_base_dir/dein.vim
  mkdir -p "$dein_base_dir"
  if [ ! -d $dein_dir ]; then
    echo
    echo -e "${CYAN}Installing dein${NC}"
    git clone https://github.com/Shougo/dein.vim $dein_dir
  else
    echo -e "${CYAN}Updating dein${NC}"
    cd $dein_dir
    git pull
    cd
    echo
  fi
fi


if $changed; then
  echo -e "${CYAN}Done.${NC}"
else
  echo -e "${CYAN}Done linking.${NC}"
fi
