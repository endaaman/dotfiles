#!/bin/bash
# written by Shotaro Fujimoto
#=#=#=
# Convert a scanned pdf to the pdf file which contains the embedded
# transparent texts generated by OCR engine 'tesseract'.
#
# **Require**
#
# * tesseract
#     * [GitHub repository](https://github.com/tesseract-ocr/tesseract)
#     * Install with `apt` command
# ```
# sudo apt-get install tesseract-ocr tesseract-ocr-jpn
# ```
#
# * pdftk
# * pdftoppm
#
# **Usage**
#
# ```
# pdfocr foo.pdf
# ```
#
# **TODO**
#
# * receive some options
#=

set -eux

target="$1"
targetwithoutext="${1%.pdf}"

# pdftoppm
mkdir -p "${targetwithoutext}.d"
# - png
# pdftoppm -png "${target}" "${targetwithoutext}.d/page"
# - ppm
# pdftoppm "${target}" "${targetwithoutext}.d/page"

# tesseract
# - png
# find "./${targetwithoutext}.d" -type f -name "*.png" | sed 's/\.png$//' | xargs -P8 -n1 -I% tesseract %.png % -l eng+jpn pdf
# - ppm
find "./${targetwithoutext}.d" -type f -name "*.ppm" | sed 's/\.ppm$//' | xargs -P8 -n1 -I% tesseract %.ppm % -l jpn pdf

# Merge to one pdf file
pdftk "./${targetwithoutext}.d"/*.pdf cat output "${targetwithoutext}-ocr.pdf"

# Clear
# rm -r "./${targetwithoutext}.d"
