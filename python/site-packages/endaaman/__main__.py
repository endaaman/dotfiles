import shutil

import torch
from endaaman import BaseCLI
from endaaman.ml import Checkpoint


class CLI(BaseCLI):
    class ConvertCheckpointArgs(BaseCLI.CommonArgs):
        base: str

    def run_convert_checkpoint(self, a):
        c = torch.load(a.base, map_location=torch.device('cpu'))
        if not isinstance(c, Checkpoint):
            print('No need to convert')
            return
        shutil.copy(a.base, f'{a.base}.back')
        d = c._asdict()
        torch.save(d, a.base)



if __name__ == '__main__':
    cli = CLI()
    cli.run()
