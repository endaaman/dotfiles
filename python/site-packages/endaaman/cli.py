import sys
import re
from string import capwords
import inspect
import asyncio
from typing import Callable, Type

from pydantic import BaseModel, Field
from pydantic.dataclasses import dataclass
from pydantic_cli import run_and_exit, SubParser, to_runner_sp


def snake_to_pascal(s):
    r = capwords(s.replace('_',' '))
    r = r.replace(' ','')
    return r

def snake_to_kebab(s):
    return s.replace('_','-')


def field(default_value, long_arg, short_arg=None):
    if short_arg:
        cli = (long_arg, short_arg)
    else:
        cli = (long_arg, )
    return Field(default_value, cli=cli)


class BaseCLI:
    version = '0.0.0'

    class CommonArgs(BaseModel):
        pass

    def _pre_common(self, a):
        pre_common = getattr(self, 'pre_common', None)
        if pre_common:
            pre_common(a)

    def wrap_runner(self, key):
        runner = getattr(self, key)
        def alt_runner(args):
            self.a = args
            self.function = key
            self._pre_common(args)
            print(f'Starting <{key}>')
            d = args.dict()
            if len(d) > 0:
                print('Args')
                maxlen = max(len(k) for k in d) if len(d) > 0 else -1
                for k, v in d.items():
                    print(f'\t{k:<{maxlen+1}}: {v}')
            else:
                print('No args')

            if inspect.iscoroutinefunction(runner):
                r = asyncio.run(runner(args))
            else:
                r =  runner(args)
            print(f'Done <{key}>')
            return r
        return alt_runner

    def register_subcommand(self, name):
        if name:
            subcommand_name = snake_to_kebab(name)
            args_class_name = snake_to_pascal(name) + 'Args'
        else:
            name = 'default'
            subcommand_name = ''
            args_class_name = 'CommonArgs'
        args_class = getattr(self, args_class_name, self.default_args_class)
        self.runners[subcommand_name] = SubParser(args_class, self.wrap_runner('run_' + name), f'sub command: {subcommand_name}')

    def __init__(self):
        self.a = None
        self.runners = {}
        self.function = None
        self.default_args_class = getattr(self.__class__, 'CommonArgs', self.CommonArgs)

        for key in dir(self):
            m = re.match(r'^run_(.*)$', key)
            if not m:
                continue
            name = m[1]
            self.register_subcommand(name)

        # self.register_subcommand(self.runners, '')

    def run(self):
        runner = to_runner_sp(self.runners, version=self.version)
        sys.exit(runner(sys.argv[1:]))


class CLI(BaseCLI):
    class FooArgs(BaseCLI.CommonArgs):
        bar = 123

    def run_foo(self, a):
        print(a.bar)

    async def run_async(self, a):
        await asyncio.sleep(1)
        print('hi')
        await asyncio.sleep(1)
        print('hi')
        await asyncio.sleep(1)
        print('hi')
        print('async')

if __name__ == '__main__':
    cli = CLI()
    cli.run()
